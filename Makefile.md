# Makefile

*2020年7月14日*



【1】命名：makefile或Makefile

 

【2】编写

​	三要素：目标，依赖，命令

​	格式如下（#注:命令缩进必须有）：

	> 目标1（生成的文件）：依赖（编译直接需要的文件）
	>
	> ​    命令
	>
	> 目标2（生成的文件）：依赖（编译直接需要的文件）
	>
	> ​    命令
	>
	> ……
	>
	> 目标n（生成的文件）：依赖（编译直接需要的文件）
	>
	> ​	命令




​		其中，目标1是终极目标，目标2，3…n是子规则，分别用来生成上面目标的依赖文件（即关系依		赖树的形式）。

​		make默认执行完成终极目标，make 目标n只完成目标n

​		注：不是所有目标都有依赖，例如删除时，不需要依赖：

​			clean：

​				rm -f *.o

​		使用时，make clean

【3】优点

​	1.简化输入的命令

​	2.可以分开编译文件，且在除了第一次编译，后续过程中只会编译改变过的文件（和直接或间接以此	文件为依赖的文件），即makefile的更新模式：当且仅当目标比依赖早（或目标不存在）才会执行更	新

​	3.由于更新模式的缘故，若目录中已经有了和某个目标同名的文件，且该目标没有依赖（例如make 	clean），makefile不会执行对应的命令。
​	解决方案：声明伪目标，使makefile始终执命令：.PHONY：目标。如：.PHONY：clean

 

【4】变量和公式

​	1.变量没有类型，直接写就行了。引用时，使用 $(变量) 来引用。其中，自定义变量一般小写，系统	维护的变量为全大写。常见：

| 系统变量 | 说明                           |
| -------- | ------------------------------ |
| CC       | 默认cc（也就是gcc）            |
| CPPFLAGS | 预处理需要的选项，如 -I（大i） |
| CFLAGS   | 编译时的参数，-Wall，-g，-c等  |
| LDFLAGS  | 链接库的选项，-l（小L），-L等  |

 

​	2.模式规则：

​	例如，在下面的例子中,左右等价

| 1                                                            | 2                                                            |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| source  = main.o sub.o<br />target  = app<br />CC =  gcc<br />app :  \$(source)  \$(CC)   \$(spurce) -o \$(target)  <br />main.o  : main.c  \$(CC) -c main.c  <br />sub.o  : sub.c  \$(CC) -c sub.c | source  = main.o sub.o  <br />target  = app  <br />CC =  gcc  <br />app :  \$(source)  \$(CC)   \$(spurce) -o \$(target)<br />%.o :  %.c  \$(CC) -c \$< -o   $@ |

​	解释：

​	%.c、%.o：自动匹配相同格式的目标和依赖，直至终极目标的所有依赖都生成（存在）【类似于通	配符 *】

​	\$< 、 $@ 、$^：自动变量，只能用于规则的命令中	

​	$<：这条规则中的第一个依赖

​	$@：这条规则中的目标

​	$^：这条规则中的所有依赖

【5】函数

​	所有makefile中的函数都有返回值

​	这里介绍3个常用函数。

| 函数 | wildcard                                 | patsubst                                                     | notdir                                                 |
| ---- | ---------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------ |
| 用法 | $(wildcard 指定目录下的文件)             | $(patsubst 原文件名，替换成的文件名，搜索范围)               | $(notdir  文件名 )                                     |
| 作用 | 获取指定目录下的指定文件，以串的形式返回 | 匹配替换。在搜索范围里寻找，若符合原文件名，则改为替换的文件名。  可包含通配符% | 把展开的文件的路径去掉，只显示文件名而不包含其路径信息 |
| 示例 | source=$(wildcard ./*.c)                 | object=\$(patsubst ./%.c,  ./%.o, $(source)  )               |                                                        |

【6】其他

​	有些命令不能执行时，会直接退出makefile。因此，应当在命令前加上 -（减号），若执行失败则忽略命令，继续执行